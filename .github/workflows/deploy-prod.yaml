name: Deploy Frontend Prod

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.VPS_HOST }}
          USERNAME: ${{ secrets.VPS_USER }}
        run: |
          echo "${SSH_PRIVATE_KEY}" > ssh_key
          chmod 600 ssh_key
          mkdir -p ~/.ssh
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          # Sync source to server (exclude build artifacts and deps)
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='.git' \
            -e "ssh -i ssh_key" \
            ./ $USERNAME@$HOST:/home/$USERNAME/frontend/cd-client-repo/

          # Build on server and deploy dist to web root (preserves nginx config)
          ssh -i ssh_key $USERNAME@$HOST "set -e && mkdir -p /home/$USERNAME/frontend/cd-client-repo /home/$USERNAME/frontend/cd-client && cd /home/$USERNAME/frontend/cd-client-repo && pnpm install && pnpm build && rm -rf /home/$USERNAME/frontend/cd-client/* && cp -r dist/* /home/$USERNAME/frontend/cd-client/ && echo 'Frontend deployed successfully'"
